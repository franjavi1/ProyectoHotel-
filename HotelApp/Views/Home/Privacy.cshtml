@{
    ViewData["Title"] = "Estadísticas";
}

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<style>
    body {
        font-family: 'Inter', sans-serif;
        background-color: #f7f9fb;
    }

    .card-glow {
        transition: all 0.3s ease-in-out;
    }

        .card-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05), 0 0 0 4px rgba(59, 130, 246, 0.1);
        }
</style>

<div class="container mx-auto px-4 py-8 md:py-12 max-w-7xl">

    <header class="mb-8 border-b pb-4">
        <h1 class="text-4xl font-extrabold text-gray-900">@ViewData["Title"]</h1>
        <p class="mt-2 text-lg text-gray-500">
            Estadísticas del hotel: reservas, ingresos y estado de pagos (últimos 6 meses).
        </p>
    </header>

    <!-- Cards -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">

        <div class="bg-white p-6 rounded-xl shadow-lg card-glow border-l-4 border-indigo-500">
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-500 uppercase">Total Reservas</span>
            </div>
            <p id="totalReservas" class="text-4xl font-bold mt-2 text-gray-800">—</p>
            <p class="text-xs text-gray-400 mt-1">Acumulado</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg card-glow border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-500 uppercase">Pagadas</span>
            </div>
            <p id="pagadas" class="text-4xl font-bold mt-2 text-gray-800">—</p>
            <p class="text-xs text-gray-400 mt-1">Con pago confirmado</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg card-glow border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-500 uppercase">No Pagadas</span>
            </div>
            <p id="noPagadas" class="text-4xl font-bold mt-2 text-gray-800">—</p>
            <p class="text-xs text-gray-400 mt-1">Pagos pendientes</p>
        </div>

        <div class="bg-white p-6 rounded-xl shadow-lg card-glow border-l-4 border-sky-500">
            <div class="flex items-center justify-between">
                <span class="text-sm font-medium text-gray-500 uppercase">Ocupadas Ahora</span>
            </div>
            <p id="ocupadasAhora" class="text-4xl font-bold mt-2 text-gray-800">—</p>
            <p id="totalHabitacionesDisplay" class="text-xs text-gray-400 mt-1">
                Habitaciones totales: <span id="totalHabitaciones">—</span>
            </p>
        </div>

    </div>

    <!-- Gráficos -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

        <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Pagos (Pagadas vs No pagadas)</h2>
            <div class="h-64 flex items-center justify-center">
                <canvas id="pagosChart"></canvas>
            </div>
        </div>

        <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Reservas por mes (últimos 6 meses)</h2>
            <div class="h-80">
                <canvas id="reservasMesChart"></canvas>
            </div>
        </div>

        <div class="lg:col-span-3 bg-white p-6 rounded-xl shadow-lg mt-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Ingresos por mes (últimos 6 meses)</h2>
            <div class="h-80">
                <canvas id="ingresosChart"></canvas>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function() {
            // Parsear los datos del controlador
            const labels = JSON.parse('@Html.Raw(ViewData["LabelsJson"] ?? "[]")');
            const reservasCounts = JSON.parse('@Html.Raw(ViewData["ReservasCountsJson"] ?? "[]")');
            const ingresos = JSON.parse('@Html.Raw(ViewData["IngresosJson"] ?? "[]")');
            const pagos = JSON.parse('@Html.Raw(ViewData["PagosJson"] ?? "[]")');
            const summary = JSON.parse('@Html.Raw(ViewData["SummaryJson"] ?? "{}")');

            const formatNumber = (value) => value !== null && value !== undefined ? value.toLocaleString('es-ES') : '0';

            const safeText = (elementId, value) => {
                const el = document.getElementById(elementId);
                if (el) el.textContent = formatNumber(value);
            };

            // Actualizar cards
            safeText('totalReservas', summary.TotalReservas);
            safeText('pagadas', summary.Pagadas);
            safeText('noPagadas', summary.NoPagadas);
            safeText('ocupadasAhora', summary.OcupadasAhora);
            document.getElementById('totalHabitaciones').textContent = formatNumber(summary.TotalHabitaciones);

            const totalHabitacionesDisplayEl = document.getElementById('totalHabitacionesDisplay');
            if (totalHabitacionesDisplayEl && summary.TotalHabitaciones > 0) {
                const occupancyRate = ((summary.OcupadasAhora / summary.TotalHabitaciones) * 100).toFixed(0);
                totalHabitacionesDisplayEl.textContent = `${occupancyRate}% Ocupación | ${formatNumber(summary.TotalHabitaciones)} Habitaciones totales`;
            }

            // Gráfico Pagos
            const ctxPagos = document.getElementById('pagosChart')?.getContext('2d');
            if (ctxPagos) {
                new Chart(ctxPagos, {
                    type: 'doughnut',
                    data: {
                        labels: ['Pagadas', 'No pagadas'],
                        datasets: [{
                            data: pagos,
                            backgroundColor: ['#10b981', '#ef4444'],
                            borderColor: '#fff',
                            borderWidth: 4,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { position: 'bottom' } },
                        cutout: '70%'
                    }
                });
            }

            // Gráfico Reservas por mes
            const ctxReservas = document.getElementById('reservasMesChart')?.getContext('2d');
            if (ctxReservas) {
                new Chart(ctxReservas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Reservas',
                            data: reservasCounts,
                            backgroundColor: 'rgba(99, 102, 241, 0.8)',
                            borderColor: 'rgb(99, 102, 241)',
                            borderWidth: 1,
                            borderRadius: 8,
                            barPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { beginAtZero: true, ticks: { precision: 0 } }
                        }
                    }
                });
            }

            // Gráfico Ingresos por mes
            const ctxIngresos = document.getElementById('ingresosChart')?.getContext('2d');
            if (ctxIngresos) {
                new Chart(ctxIngresos, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Ingresos',
                            data: ingresos,
                            fill: true,
                            backgroundColor: (ctx) => {
                                const chart = ctx.chart;
                                const { ctx: c, chartArea } = chart;
                                if (!chartArea) return;
                                const gradient = c.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                                gradient.addColorStop(0, 'rgba(6, 182, 212, 0.1)');
                                gradient.addColorStop(1, 'rgba(6, 182, 212, 0.5)');
                                return gradient;
                            },
                            borderColor: 'rgb(6, 182, 212)',
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: 'rgb(6, 182, 212)',
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false } },
                            y: { ticks: { callback: v => '$' + v.toLocaleString('es-ES', { maximumFractionDigits: 0 }) }, beginAtZero: true }
                        }
                    }
                });
            }

        })();
    </script>
}
